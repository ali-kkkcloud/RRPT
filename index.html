<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G4S Fleet Management Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="logo">
                        <div class="logo-icon">üöõ</div>
                        <div class="logo-text">
                            <h1>G4S Fleet Dashboard</h1>
                            <p>Last updated: <span id="last-updated"></span></p>
                        </div>
                    </div>
                </div>
                <div class="header-controls">
                    <!-- User Role Display -->
                    <div class="user-role">
                        <span class="role-badge" id="current-role">Admin</span>
                        <button id="role-toggle" class="btn btn-secondary">Switch to Viewer</button>
                    </div>
                    
                    <!-- Theme Toggle -->
                    <button id="theme-toggle" class="btn btn-secondary">
                        <span class="theme-icon">üåô</span>
                    </button>
                    
                    <!-- View Period Toggle -->
                    <div class="period-toggle">
                        <button class="period-btn active" data-period="daily">Daily</button>
                        <button class="period-btn" data-period="weekly">Weekly</button>
                        <button class="period-btn" data-period="monthly">Monthly</button>
                    </div>
                    
                    <div class="date-selector">
                        <label for="date-select">üìÖ Select Date:</label>
                        <select id="date-select">
                            <option value="25 August">25 August</option>
                            <option value="24 August">24 August</option>
                            <option value="23 August">23 August</option>
                        </select>
                    </div>
                    
                    <button id="refresh-btn" class="btn btn-primary">üîÑ Refresh</button>
                </div>
            </div>
        </header>

        <!-- Smart Filters & Search -->
        <div class="filters-section">
            <div class="search-container">
                <input type="text" id="global-search" placeholder="üîç Search vehicles, alerts, locations..." />
                <button id="clear-search" class="btn btn-secondary">Clear</button>
            </div>
            
            <div class="filters-grid">
                <select id="filter-city">
                    <option value="">All Cities</option>
                    <option value="North">North</option>
                    <option value="South">South</option>
                    <option value="East">East</option>
                    <option value="West">West</option>
                </select>
                
                <select id="filter-vehicle">
                    <option value="">All Vehicles</option>
                </select>
                
                <select id="filter-status">
                    <option value="">All Status</option>
                    <option value="Online">Online</option>
                    <option value="Offline">Offline</option>
                    <option value="Parking">Parking</option>
                    <option value="Technical">Technical Issue</option>
                </select>
                
                <button id="export-pdf" class="btn btn-primary">üìÑ Export PDF</button>
                <button id="export-excel" class="btn btn-secondary">üìä Export Excel</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <nav class="tab-navigation">
            <button class="tab-btn active" data-tab="offline">
                <span class="tab-icon">üî¥</span>
                Offline Reports
            </button>
            <button class="tab-btn" data-tab="ai-alerts">
                <span class="tab-icon">üö®</span>
                AI Alerts
            </button>
            <button class="tab-btn" data-tab="speed">
                <span class="tab-icon">‚ö°</span>
                Speed Alarm
            </button>
            <button class="tab-btn" data-tab="insights">
                <span class="tab-icon">üß†</span>
                AI Insights
            </button>
        </nav>

        <!-- Tab Content -->
        <main class="tab-content">
            <!-- Offline Reports Tab -->
            <div id="offline" class="tab-pane active">
                <div class="summary-cards">
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Total Offline</h3>
                            <span class="card-icon">üî¥</span>
                        </div>
                        <div class="card-value" id="total-offline">0</div>
                        <div class="card-trend" id="offline-trend">üìà +5% vs last period</div>
                    </div>
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Parking/Garage</h3>
                            <span class="card-icon">üÖøÔ∏è</span>
                        </div>
                        <div class="card-value" id="parking-count">0</div>
                        <div class="card-trend" id="parking-trend">üìä Stable</div>
                    </div>
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Technical Issues</h3>
                            <span class="card-icon">üîß</span>
                        </div>
                        <div class="card-value" id="technical-count">0</div>
                        <div class="card-trend" id="technical-trend">üìâ -2% improvement</div>
                    </div>
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Avg Offline Hours</h3>
                            <span class="card-icon">‚è∞</span>
                        </div>
                        <div class="card-value" id="avg-offline">0</div>
                        <div class="card-trend" id="avg-trend">‚öñÔ∏è Within normal range</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container animate-card">
                        <h3>Status Distribution</h3>
                        <canvas id="status-pie-chart"></canvas>
                    </div>
                    <div class="chart-container animate-card">
                        <h3>Regional Distribution</h3>
                        <canvas id="region-bar-chart"></canvas>
                    </div>
                    <div class="chart-container animate-card">
                        <h3>Offline Trend (7 Days)</h3>
                        <canvas id="offline-trend-chart"></canvas>
                    </div>
                </div>

                <div class="data-table-container animate-card">
                    <div class="table-header">
                        <h3>Offline Vehicles</h3>
                        <div class="table-controls">
                            <input type="text" id="offline-search" placeholder="Search vehicles..." />
                            <button id="offline-export" class="btn btn-secondary">Export</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="offline-table">
                            <thead>
                                <tr>
                                    <th>Vehicle Number</th>
                                    <th>Last Online</th>
                                    <th>Offline Hours</th>
                                    <th>Current Status</th>
                                    <th>Remarks</th>
                                    <th class="admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AI Alerts Tab -->
            <div id="ai-alerts" class="tab-pane">
                <div class="summary-cards">
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Total Alerts</h3>
                            <span class="card-icon">üö®</span>
                        </div>
                        <div class="card-value" id="total-alerts">0</div>
                        <div class="card-trend" id="alerts-trend">üìà +12% vs last period</div>
                    </div>
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Unique Vehicles</h3>
                            <span class="card-icon">üöõ</span>
                        </div>
                        <div class="card-value" id="unique-vehicles-alerts">0</div>
                        <div class="card-trend">üìä Vehicle coverage</div>
                    </div>
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Top Violator</h3>
                            <span class="card-icon">‚ö†Ô∏è</span>
                        </div>
                        <div class="card-value" id="top-violator">-</div>
                        <div class="card-trend" id="violator-trend">üéØ Focus area</div>
                    </div>
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>High Priority</h3>
                            <span class="card-icon">üî•</span>
                        </div>
                        <div class="card-value" id="high-priority-alerts">0</div>
                        <div class="card-trend">‚ö° Immediate attention</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container animate-card">
                        <h3>Vehicle-wise Alerts</h3>
                        <canvas id="vehicle-alerts-chart"></canvas>
                    </div>
                    <div class="chart-container animate-card">
                        <h3>Alert Type Distribution</h3>
                        <canvas id="alert-type-chart"></canvas>
                    </div>
                    <div class="chart-container animate-card">
                        <h3>Hourly Alert Pattern</h3>
                        <canvas id="hourly-alerts-chart"></canvas>
                    </div>
                </div>

                <div class="data-table-container animate-card">
                    <div class="table-header">
                        <h3>AI Alerts Details</h3>
                        <div class="table-controls">
                            <input type="text" id="alerts-search" placeholder="Search alerts..." />
                            <select id="alert-type-filter">
                                <option value="">All Alert Types</option>
                                <option value="Distracted Driving">Distracted Driving</option>
                                <option value="Call Alarm">Call Alarm</option>
                                <option value="Unfastened Seat Belt">Unfastened Seat Belt</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="alerts-table">
                            <thead>
                                <tr>
                                    <th>Vehicle</th>
                                    <th>Company</th>
                                    <th>Alert Type</th>
                                    <th>Time</th>
                                    <th>Priority</th>
                                    <th>Evidence</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Speed Alarm Tab -->
            <div id="speed" class="tab-pane">
                <div class="summary-cards">
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Total Violations</h3>
                            <span class="card-icon">üö®</span>
                        </div>
                        <div class="card-value" id="total-violations">0</div>
                        <div class="card-trend" id="violations-trend">üìâ -8% vs last period</div>
                    </div>
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Warnings (75-89)</h3>
                            <span class="card-icon">‚ö†Ô∏è</span>
                        </div>
                        <div class="card-value" id="warning-count">0</div>
                        <div class="card-trend">üü° Moderate risk</div>
                    </div>
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Alarms (90+)</h3>
                            <span class="card-icon">üö®</span>
                        </div>
                        <div class="card-value" id="alarm-count">0</div>
                        <div class="card-trend">üî¥ High risk</div>
                    </div>
                    <div class="card animate-card">
                        <div class="card-header">
                            <h3>Max Speed</h3>
                            <span class="card-icon">üìà</span>
                        </div>
                        <div class="card-value" id="max-speed">0</div>
                        <div class="card-trend" id="max-speed-trend">‚ö° Peak recorded</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container animate-card">
                        <h3>Speed Violations by Vehicle</h3>
                        <canvas id="speed-violations-chart"></canvas>
                    </div>
                    <div class="chart-container animate-card">
                        <h3>Speed Category Distribution</h3>
                        <canvas id="speed-category-chart"></canvas>
                    </div>
                    <div class="chart-container animate-card">
                        <h3>Speed Violations Over Time</h3>
                        <canvas id="speed-timeline-chart"></canvas>
                    </div>
                </div>

                <div class="data-table-container animate-card">
                    <div class="table-header">
                        <h3>Speed Violations Details</h3>
                        <div class="table-controls">
                            <input type="text" id="speed-search" placeholder="Search violations..." />
                            <select id="speed-filter">
                                <option value="">All Speeds</option>
                                <option value="warning">Warnings (75-89)</option>
                                <option value="alarm">Alarms (90+)</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="speed-table">
                            <thead>
                                <tr>
                                    <th>Vehicle</th>
                                    <th>Company</th>
                                    <th>Max Speed</th>
                                    <th>Warnings</th>
                                    <th>Alarms</th>
                                    <th>Risk Level</th>
                                    <th>Total Violations</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AI Insights Tab -->
            <div id="insights" class="tab-pane">
                <div class="insights-container">
                    <div class="insight-card animate-card">
                        <div class="insight-header">
                            <h3>üß† AI-Powered Fleet Analysis</h3>
                            <span class="last-analyzed">Last analyzed: <span id="analysis-time"></span></span>
                        </div>
                        
                        <div class="insights-grid">
                            <div class="insight-section">
                                <h4>üìä Performance Summary</h4>
                                <div id="performance-summary" class="insight-content">
                                    <p>Analyzing fleet performance...</p>
                                </div>
                            </div>
                            
                            <div class="insight-section">
                                <h4>‚ö†Ô∏è Risk Assessment</h4>
                                <div id="risk-assessment" class="insight-content">
                                    <p>Calculating risk factors...</p>
                                </div>
                            </div>
                            
                            <div class="insight-section">
                                <h4>üìà Trends & Predictions</h4>
                                <div id="trend-predictions" class="insight-content">
                                    <p>Identifying patterns...</p>
                                </div>
                            </div>
                            
                            <div class="insight-section">
                                <h4>üí° Recommendations</h4>
                                <div id="recommendations" class="insight-content">
                                    <p>Generating recommendations...</p>
                                </div>
                            </div>
                        </div>
                        
                        <button id="regenerate-insights" class="btn btn-primary">üîÑ Regenerate Analysis</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Status Edit Modal -->
    <div id="status-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Vehicle Status</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Vehicle: <strong id="modal-vehicle"></strong></p>
                <div class="form-group">
                    <label for="status-select">Status:</label>
                    <select id="status-select">
                        <option value="Online">‚úÖ Online</option>
                        <option value="Parking/Garage">üÖøÔ∏è Parking/Garage</option>
                        <option value="Dashcam Issue">üì∑ Dashcam Issue</option>
                        <option value="Technical Problem">üîß Technical Problem</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reason-input">Reason (Optional):</label>
                    <textarea id="reason-input" placeholder="Enter reason for status update..." rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-status" class="btn btn-primary">Save</button>
                <button id="cancel-status" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Install PWA Prompt -->
    <div id="install-prompt" class="install-prompt" style="display: none;">
        <div class="install-content">
            <h3>üì± Install G4S Dashboard</h3>
            <p>Add this app to your home screen for quick access!</p>
            <div class="install-buttons">
                <button id="install-yes" class="btn btn-primary">Install</button>
                <button id="install-no" class="btn btn-secondary">Maybe Later</button>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading fleet data...</p>
    </div>

    <script src="app.js"></script>
</body>
</html>
